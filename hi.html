<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Chat Recommender</title>
  <style>
    :root{--bg:#f5f0ff;--panel:#ffffff;--me:#6b46c1;--bot:#805ad5;--text:#2d225a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,#dccbff 0%, #f8f3ff 100%);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .chat-wrap{width:100%;max-width:720px;background:var(--panel);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .avatar{width:48px;height:48px;border-radius:10px;background:#805ad5;display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    .title{font-size:1.25rem;font-weight:700}
    .subtitle{font-size:.85rem;color:#6a5c99}

    .messages{height:340px;overflow:auto;padding:10px;border-radius:8px;background:#f7f2ff;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:78%;padding:10px 12px;border-radius:14px;color:var(--text);line-height:1.25;font-size:.95rem}
    .me{align-self:flex-end;background:linear-gradient(180deg,var(--me),#55308f);color:white;border-bottom-right-radius:6px}
    .bot{align-self:flex-start;background:#e8dbff;border-bottom-left-radius:6px}
    .meta{font-size:.72rem;color:#6e5e9e;margin-top:6px;opacity:.9}

    .idol-img{width:120px;border-radius:12px;margin:6px 0;box-shadow:0 4px 14px rgba(0,0,0,.15)}

    .input-bar{display:flex;gap:8px;margin-top:12px}
    .input-bar input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #d7caff;background:white;color:var(--text);outline:none}
    .input-bar button{padding:0 18px;border-radius:10px;border:0;background:linear-gradient(90deg,#9f7aea,#6b46c1);color:white;font-weight:700;cursor:pointer}

    .typing{display:inline-block;font-style:italic;color:#6e5e9e}
  </style>
</head>
<body>
  <main class="chat-wrap">
    <div class="header">
      <div class="avatar">AI</div>
      <div>
        <div class="title">Movie Recommender Chat</div>
        <div class="subtitle">Ask for movie suggestions — friendly themed chat!</div>
      </div>
    </div>

    <section class="messages" id="messages"></section>

    <div class="input-bar">
      <input id="input" autocomplete="off" placeholder="What kind of movie are you in the mood for?">
      <button id="send" onclick="send()">Send</button>
    </div>
  </main>

  <template id="tpl-message">
    <article class="msg">
      <div class="text"></div>
      <div class="meta"></div>
    </article>
  </template>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const tpl = document.getElementById('tpl-message');

    function appendMessage(text, who='bot', img=null){
      const node = tpl.content.firstElementChild.cloneNode(true);
      const textEl = node.querySelector('.text');
      const metaEl = node.querySelector('.meta');

      textEl.textContent = text;

      if(img){
        const im = document.createElement('img');
        im.src = img;
        im.className = 'idol-img';
        textEl.appendChild(document.createElement('br'));
        textEl.appendChild(im);
      }

      const now = new Date();
      metaEl.textContent = (who==='me'?'You':'Bot') + ' • ' + now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      node.classList.add(who==='me'?'me':'bot');

      messagesEl.appendChild(node);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ✅ simulateReply calls backend server instead of OpenAI directly
    async function simulateReply(userText) {
      const typing = document.createElement('div');
      typing.className = 'msg bot';
      typing.innerHTML = '<div class="text"><span class="typing">Bot is typing…</span></div><div class="meta">Bot • …</div>';
      messagesEl.appendChild(typing);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try {
        const response = await fetch("http://localhost:3000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userText })
        });

        if (!response.ok) throw new Error("Server error " + response.status);

        const data = await response.json();
        typing.remove();
        appendMessage(data.reply, "bot");

      } catch (err) {
        console.error(err);
        typing.remove();
        appendMessage("Oops, the server had an issue. Try again later.", "bot");
      }
    }

    window.send = function send(){
      const val = inputEl.value.trim();
      if(!val) return;
      appendMessage(val,'me');
      inputEl.value='';
      inputEl.focus();
      simulateReply(val);
    }

    sendBtn.addEventListener('click', () => send());
    inputEl.addEventListener('keydown', e =>{
      if(e.key === 'Enter'){ e.preventDefault(); send(); }
    });

    appendMessage("Welcome! Ask me for movie recommendations anytime!", 'bot');
  </script>
</body>
</html>
